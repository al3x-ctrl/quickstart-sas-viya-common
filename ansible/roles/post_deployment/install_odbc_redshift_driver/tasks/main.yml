---


- name: install driver
  yum:
    name: https://s3.amazonaws.com/redshift-downloads/drivers/odbc/1.4.3.1000/AmazonRedshiftODBC-64-bit-1.4.3.1000-1.x86_64.rpm
    state: installed

# Also, in the prepare_deployment/update_vars role append /opt/amazon/redshiftodbc/lib/64/libamazonredshiftodbc64.so to LD_LIBRARY_PATH


- name: determine spre/viya
  stat:
    path: /opt/sas/spre/home
  register: is_spre

- set_fact:
     subdir: "{% if is_spre.stat.exists==True %}spre{% else %}viya{% endif %}"

- debug:
    var: subdir


- name: create accessclients subdir if needed
  file:
    path: /opt/sas/{{ subdir }}/home/lib64/accessclients
    state: directory
    owner: root
    group: root
    mode: 0755
# - name: create odbcinst.ini if needed on services host
#   file:
#      path: /opt/sas/{{ subdir}}/home/lib64/accessclients/odbcinst.ini
#      state: touch
#      owner: root
#      group: root
#      mode: 0777



- set_fact:
    driver_definition: |+
      [Redshift]
      Description=ODBC for Amazon Redshift
      Driver=/opt/amazon/redshiftodbc/lib/64/libamazonredshiftodbc64.so

- name: install driver
  shell:  |
    export ODBCSYSINI="/opt/sas/{{ subdir }}/home/lib64/accessclients"
    echo "{{driver_definition}}" | {{UNIXODBC_LOCATION}}/bin/odbcinst -i -d -r

# - lineinfile:
#     path: /opt/sas/{{ subdir }}/home/lib64/accessclients/odbcinst.ini
#     insertbefore: BOF
#     state: present
#     line: '[ODBC Drivers]'

# - lineinfile:
#     path: /opt/sas/{{ subdir }}/home/lib64/accessclients/odbcinst.ini
#     insertafter: '\[ODBC Drivers\]'
#     state: present
#     line: '[ODBC]'

# - name: Add driver definition to odbcinst.ini (controller)
#   blockinfile:
#     dest: /opt/sas/{{ subdir }}/home/lib64/accessclients/odbcinst.ini
#     marker: <!-- {mark} Redshift ODBC Driver -->
#     block: "{{ driver_definition }}"

# - lineinfile:
#     path: /opt/sas/{{ subdir }}/home/lib64/accessclients/odbcinst.ini
#     insertafter: '^\[ODBC\ Drivers\]'
#     state: present
#     line: 'Redshift=Installed'
